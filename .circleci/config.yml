version: 2
jobs:
  # generic ubuntu build
  build:
    docker:
      - image: ubuntu:bionic
    steps:
      - checkout
      - run:
          name: update base image
          command: apt update -y
      - run:
          name: install dependencies
          command: apt install libssl-dev libyaml-dev libncurses-dev libc-ares-dev libprotobuf-dev protobuf-compiler libjq-dev libyaml-cpp-dev libgrpc++-dev protobuf-compiler-grpc rpm linux-headers-$(uname -r) libelf-dev cmake build-essential libcurl4-openssl-dev -y
      - run:
          name: build all
          command: |
            mkdir build
            pushd build
            cmake ..
            make -j4 all
            popd
      - run:
          name: run unit tests
          command: |
            pushd build
            make tests
            popd
  # build using our own builder base image
  builder:
    docker:
      - image: falcosecurity/falco-builder:dynamic-build # todo(fntlnz): replace this with the actual image once PR #968 is merged
    steps:
      - checkout
      - run:
          name: prepare project
          command: cmake
      - persist_to_workspace:
          root: .
          paths:
            - build/*
  # execute integration tests based on the build results coming from the "builder" job
  integration:
    docker:
      - image: falcosecurity/falco-tester:latest
    steps:
      - checkout
      - attach_workspace:
          at: build
      - run:
          name: prepare project
          command: cmake
